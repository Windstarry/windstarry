import{_ as s,o as a,c as n,W as l}from"./chunks/framework.1977b413.js";const o="/windstarry/assets/22c08fcb832bf2fb7df27ee07981c4117417dd56bcc5e9f14059b11ed07b434e.22c08fcb.png",d=JSON.parse('{"title":"FastAPI对数据库的增删改查","description":"FastAPI对数据库的增删改查","frontmatter":{"title":"FastAPI对数据库的增删改查","description":"FastAPI对数据库的增删改查","date":"2023-4-10","recommend":2,"sticky":4,"tags":["python","项目实战","FastApi"],"categories":["python","FastApi"]},"headers":[],"relativePath":"learn/python/FastAPI对数据库的增删改查.md"}'),p={name:"learn/python/FastAPI对数据库的增删改查.md"},e=l(`<h1 id="fastapi对数据库的增删改查" tabindex="-1">FastAPI对数据库的增删改查 <a class="header-anchor" href="#fastapi对数据库的增删改查" aria-label="Permalink to &quot;FastAPI对数据库的增删改查&quot;">​</a></h1><h2 id="前言" tabindex="-1">前言 <a class="header-anchor" href="#前言" aria-label="Permalink to &quot;前言&quot;">​</a></h2><p>FastAPI对数据库的操作通常是采用SQLAlchemy来实现的，这主要是由于后者会以面向对象的方式来操作表，同时SQLAlchemy用统一的接口使得程序与数据库相分离，降低了耦合度。 在FastAPI的官方文档中，有专门对SQLAlcheym的介绍，只不过该示例中是两个表，且表与表之间有外键约束，为了更清楚让刚入门的同学快速掌握FastAPI对数据库的操作，本文将以一个简单的表来说明如何在FastAPI中实现对数据库的增删改查操作。</p><h2 id="整体思路" tabindex="-1">整体思路 <a class="header-anchor" href="#整体思路" aria-label="Permalink to &quot;整体思路&quot;">​</a></h2><p>在官方文档中，FastAPI采用SQLAlchemy对数据库的操作是采用一种非常清晰的模块划分方式，即要操作一个数据表，通常用五个文件来实现：</p><ul><li>数据库配置文件： <strong>database.py</strong>主要完成对数据库的连接；</li><li>数据库中表对应的模型文件： <strong>models.py</strong>建立所需要的表对应的数据模型；</li><li>数据库中表所对应的架构文件： <strong>schemas.py</strong>这里采用pydantic来完成对数据表的基本校验，其实质是建立与表对应的类，它与<strong>models.py</strong>中类的区别在于<strong>models.py</strong>中是与表严格对应的，而schemas则可以根据表模型来定制适合不同场景的类。</li><li>增删改查操作文件： <strong>crud.py</strong>该文件中主要完成对数据库的各种读写操作。</li><li>主文件 <strong>main.py</strong>这里配置各种路由及get、post等方法。 本例中将以一个图书数据库来实现增删改查操作。接下来一起看看各种文件的设定。</li></ul><h2 id="一、数据库的连接" tabindex="-1">一、数据库的连接 <a class="header-anchor" href="#一、数据库的连接" aria-label="Permalink to &quot;一、数据库的连接&quot;">​</a></h2><p>在本例中，我们将以sqlite3数据库来实现图书数据库的管理，这里要注意的是，如果采用sqlite3，则配置中的<strong>check_same_thread</strong>标记要设定为False，这是因为sqlite3数据库本身并非一个网络数据库，其默认只能在同一线程中使用，如果不设定该标记，则SQLAlchemy会提示错误，具体代码如下所示：</p><blockquote><p>backend/database.py</p></blockquote><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> sqlalchemy </span><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> create_engine </span><span style="color:#676E95;font-style:italic;"># type: ignore</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> sqlalchemy</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">ext</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">declarative </span><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> declarative_base </span><span style="color:#676E95;font-style:italic;"># type: ignore</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> sqlalchemy</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">orm </span><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> sessionmaker </span><span style="color:#676E95;font-style:italic;"># type: ignore</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">SQLALCHEMY_DATABASE_URL </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">sqlite:///./sql_app.db</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">engine </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">create_engine</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#82AAFF;">    SQLALCHEMY_DATABASE_URL</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">connect_args</span><span style="color:#89DDFF;">={</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">check_same_thread</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#82AAFF;"> </span><span style="color:#89DDFF;">False}</span></span>
<span class="line"><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">SessionLocal </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">sessionmaker</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">autocommit</span><span style="color:#89DDFF;">=False,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">autoflush</span><span style="color:#89DDFF;">=False,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">bind</span><span style="color:#89DDFF;">=</span><span style="color:#82AAFF;">engine</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">Base </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">declarative_base</span><span style="color:#89DDFF;">()</span></span>
<span class="line"></span></code></pre></div><p>在上述代码中，通过创建一个SessionLocal变量，将当前数据库的连接保存于其中，这样可在其它文件中将其导入使用。 Base是SQLAlchemy的总类，与数据库表对应的数据模型均须继承它。</p><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>如果要使用mysql数据库，则连接字符串如下：&quot;mysql+pymysql://用户名:密码@主机IP:端口/数据库名?charset=utf8&quot; 建立数据表模型</p></div><p>为演示简单，这里的数据表仅包含三个字段：ID、书名、定价。在当前目录下建立文件<strong>models.py</strong>代码如下：</p><blockquote><p>backend/models.py</p></blockquote><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> sqlalchemy </span><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> Column</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> Integer</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> String  </span><span style="color:#676E95;font-style:italic;"># type: ignore</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">database </span><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> Base</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Books</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">Base</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">    __tablename__ </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">books</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">id</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Column</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">Integer</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">primary_key</span><span style="color:#89DDFF;">=True,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">index</span><span style="color:#89DDFF;">=True)</span></span>
<span class="line"><span style="color:#A6ACCD;">    bookname </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Column</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">String</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">100</span><span style="color:#89DDFF;">),</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">unique</span><span style="color:#89DDFF;">=True)</span></span>
<span class="line"><span style="color:#A6ACCD;">    prices </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Column</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">Integer</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span></code></pre></div><p>在上述代码中，我们建立了表名为books的类Books，该类包含了之前提到的三个字段，注意，这里的书名价格用的是整数表示。 在这里，我们用<code>from .database import Base</code>导入了刚才创建的基类，对于某些编辑器会提示这里的导入警告，一个合适的办法是在当前文件夹下新建一个__init__.py空文件，这样语法检查器会认为这是一个包，可以被导入而不会出现警告信息。</p><h2 id="二、建立架构文件" tabindex="-1">二、建立架构文件 <a class="header-anchor" href="#二、建立架构文件" aria-label="Permalink to &quot;二、建立架构文件&quot;">​</a></h2><p>在<a href="./关于FastAPI与Vue3的通信.html">关于FastAPI与Vue3的通信</a>已经介绍过利用pydantic来检验前端传输数据的功能，这里同样用该包来完成输入或输出数据的类设定，在同一个目录下建立文件<strong>schemas.py</strong>文件，其中建立一个与模型类完全一致的类，这主要是要利用其id属性来完成更改数据的功能，再建立一个去掉id的类，用来新建数据时使用，代码如下：</p><blockquote><p>backend/schemas.py</p></blockquote><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> typing </span><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> Union</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> pydantic </span><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> BaseModel</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Books</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">BaseModel</span><span style="color:#89DDFF;">):</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">id</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> Union</span><span style="color:#89DDFF;">[</span><span style="color:#FFCB6B;">int</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">None]=None</span><span style="color:#A6ACCD;">   </span></span>
<span class="line"><span style="color:#A6ACCD;">    bookname </span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">str</span></span>
<span class="line"><span style="color:#A6ACCD;">    prices </span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> Union</span><span style="color:#89DDFF;">[</span><span style="color:#FFCB6B;">int</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">None]</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">None</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Config</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">        orm_mode </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">True</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">BooksBase</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">BaseModel</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">    bookname </span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">str</span></span>
<span class="line"><span style="color:#A6ACCD;">    prices </span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> Union</span><span style="color:#89DDFF;">[</span><span style="color:#FFCB6B;">int</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">None]</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">None</span></span>
<span class="line"></span></code></pre></div><div class="tip custom-block"><p class="custom-block-title">代码解释</p><p>在上述代码中，类Books有一个内部类class Config，这是pydantic中的一个配置，将其中的orm_mode设定为True，即告诉pydantic，这是一个可以直接映射为对象关系模型的类。而BooksBase类则只是对数据进行校验。</p></div><p>当然，我们可以利用类的继承功能，将上述代码改写如下：</p><blockquote><p>backend/schemas.py</p></blockquote><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> typing </span><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> Union</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> pydantic </span><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> BaseModel</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">BooksBase</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">BaseModel</span><span style="color:#89DDFF;">):</span><span style="color:#A6ACCD;">     </span></span>
<span class="line"><span style="color:#A6ACCD;">    bookname </span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">str</span></span>
<span class="line"><span style="color:#A6ACCD;">    prices </span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> Union</span><span style="color:#89DDFF;">[</span><span style="color:#FFCB6B;">int</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">None]</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">None</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Books</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">BooksBase</span><span style="color:#89DDFF;">):</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">id</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> Union</span><span style="color:#89DDFF;">[</span><span style="color:#FFCB6B;">int</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">None]=None</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Config</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">        orm_mode </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">True</span></span>
<span class="line"></span></code></pre></div><h2 id="三、增删改查" tabindex="-1">三、增删改查 <a class="header-anchor" href="#三、增删改查" aria-label="Permalink to &quot;三、增删改查&quot;">​</a></h2><p>对数据表的操作单独用一个文件来收集，在同一个目录下建立文件<strong>crud.py</strong>，其中的增删改查代码如下：</p><blockquote><p>backend/crud.py</p></blockquote><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> datetime </span><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> date</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> sqlalchemy</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">orm </span><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> Session</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> models</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> schemas </span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 根据书名查询，支持模糊查询</span></span>
<span class="line"><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">get_books_by_name</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">db</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> Session</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">bookname</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">str</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> db</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">query</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">models</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">Books</span><span style="color:#89DDFF;">).</span><span style="color:#82AAFF;">filter</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">models</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">Books</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">bookname</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">like</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">f</span><span style="color:#C3E88D;">&quot;%</span><span style="color:#F78C6C;">{</span><span style="color:#82AAFF;">bookname</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;">%&quot;</span><span style="color:#89DDFF;">)).</span><span style="color:#82AAFF;">all</span><span style="color:#89DDFF;">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 根据书的\`ID\`删除</span></span>
<span class="line"><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">delete_book_by_Id</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">db</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">Session</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">bookId</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;">int</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">    db_book </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> db</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">query</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">models</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">Books</span><span style="color:#89DDFF;">).</span><span style="color:#82AAFF;">filter</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">models</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">Books</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">id</span><span style="color:#82AAFF;"> </span><span style="color:#89DDFF;">==</span><span style="color:#82AAFF;"> bookId</span><span style="color:#89DDFF;">).</span><span style="color:#82AAFF;">one_or_none</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> db_book </span><span style="color:#89DDFF;">is</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">None:</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">None</span></span>
<span class="line"><span style="color:#A6ACCD;">    db</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">delete</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">db_book</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    db</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">commit</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">True</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 增加书籍信息</span></span>
<span class="line"><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">create_book</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">db</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">Session</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">book</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">schemas</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">BooksBase</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">    curBook </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> models</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Books</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#82AAFF;">        </span><span style="color:#A6ACCD;font-style:italic;">bookname</span><span style="color:#82AAFF;"> </span><span style="color:#89DDFF;">=</span><span style="color:#82AAFF;"> book</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">bookname</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#82AAFF;">        </span><span style="color:#A6ACCD;font-style:italic;">prices</span><span style="color:#82AAFF;"> </span><span style="color:#89DDFF;">=</span><span style="color:#82AAFF;"> book</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">prices</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;">        </span></span>
<span class="line"><span style="color:#82AAFF;">    </span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    db</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">add</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">curBook</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    db</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">commit</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">    db</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">refresh</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">curBook</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> curBook</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 根据书的\`ID\`修改书籍信息</span></span>
<span class="line"><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">update_book_by_id</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">db</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">Session</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">bookId</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;">int</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">book</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">schemas</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">BooksBase</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">    db_book </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> db</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">query</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">models</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">Books</span><span style="color:#89DDFF;">).</span><span style="color:#82AAFF;">filter</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">models</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">Books</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">id</span><span style="color:#82AAFF;"> </span><span style="color:#89DDFF;">==</span><span style="color:#82AAFF;"> bookId</span><span style="color:#89DDFF;">).</span><span style="color:#82AAFF;">one_or_none</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> db_book </span><span style="color:#89DDFF;">is</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">None:</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">None</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># Update model class variable from requested fields </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> var</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> value </span><span style="color:#89DDFF;font-style:italic;">in</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">vars</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">book</span><span style="color:#89DDFF;">).</span><span style="color:#82AAFF;">items</span><span style="color:#89DDFF;">():</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">setattr</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">db_book</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> var</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> value</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> value </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">None</span></span>
<span class="line"><span style="color:#A6ACCD;">    db</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">commit</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">    db</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">refresh</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">db_book</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> db_book</span></span>
<span class="line"></span></code></pre></div><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>上述修改书籍的代码中，我们利用了Python中的vars这个函数，它可以将一个对象的所有属性以字典的方式列举。</p></div><h2 id="四、整合路由" tabindex="-1">四、整合路由 <a class="header-anchor" href="#四、整合路由" aria-label="Permalink to &quot;四、整合路由&quot;">​</a></h2><p>最后，我们在该目录下的<strong>main.py</strong>文件中设定各种不同的路由，调用上述<strong>crud.py</strong>中的函数来完成对数据表的增删改查，代码如下：</p><blockquote><p>backend/main.py</p></blockquote><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> fastapi </span><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> Depends</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> FastAPI</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> HTTPException</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> sqlalchemy</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">orm </span><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> Session </span><span style="color:#676E95;font-style:italic;">#type: ignore</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> crud</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> schemas</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> models</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">database </span><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> SessionLocal</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> engine</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 根据模板文件创建对应的数据表</span></span>
<span class="line"><span style="color:#A6ACCD;">models</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">Base</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">metadata</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">create_all</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">bind</span><span style="color:#89DDFF;">=</span><span style="color:#82AAFF;">engine</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">app </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">FastAPI</span><span style="color:#89DDFF;">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 设定数据库连接</span></span>
<span class="line"><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">get_db</span><span style="color:#89DDFF;">():</span></span>
<span class="line"><span style="color:#A6ACCD;">    db </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">SessionLocal</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">try</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">yield</span><span style="color:#A6ACCD;"> db</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">finally</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">        db</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">close</span><span style="color:#89DDFF;">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 查询书籍</span></span>
<span class="line"><span style="color:#89DDFF;">@</span><span style="color:#82AAFF;">app</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">/books/</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">response_model</span><span style="color:#89DDFF;">=</span><span style="color:#82AAFF;">list</span><span style="color:#89DDFF;">[</span><span style="color:#82AAFF;">schemas</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">Books</span><span style="color:#89DDFF;">])</span></span>
<span class="line"><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">get_hospital_nums</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">bookname</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;">str</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">db</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">Session</span><span style="color:#89DDFF;">=</span><span style="color:#82AAFF;">Depends</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">get_db</span><span style="color:#89DDFF;">)):</span></span>
<span class="line"><span style="color:#A6ACCD;">    db_books </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> crud</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get_books_by_name</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">db</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">bookname</span><span style="color:#89DDFF;">=</span><span style="color:#82AAFF;">bookname</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">not</span><span style="color:#A6ACCD;"> db_books</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">raise</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">HTTPException</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">status_code</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">400</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">detail</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">当前书籍名称未查询到相匹配的书籍。</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> db_books</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 删除书籍</span></span>
<span class="line"><span style="color:#89DDFF;">@</span><span style="color:#82AAFF;">app</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">post</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">/deleteBook/</span><span style="color:#F78C6C;">{bookid}</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">delete_book</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">bookid</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;">int</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">db</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">Session</span><span style="color:#89DDFF;">=</span><span style="color:#82AAFF;">Depends</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">get_db</span><span style="color:#89DDFF;">)):</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> crud</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">delete_book_by_Id</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">db</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">bookId</span><span style="color:#89DDFF;">=</span><span style="color:#82AAFF;">bookid</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 修改书籍</span></span>
<span class="line"><span style="color:#89DDFF;">@</span><span style="color:#82AAFF;">app</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">post</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">/updateBook/</span><span style="color:#F78C6C;">{bookid}</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">response_model</span><span style="color:#89DDFF;">=</span><span style="color:#82AAFF;">schemas</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">Books</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">update_book</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">bookid</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;">int</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">book</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">schemas</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">BooksBase</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">db</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">Session</span><span style="color:#89DDFF;">=</span><span style="color:#82AAFF;">Depends</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">get_db</span><span style="color:#89DDFF;">)):</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> crud</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">update_book_by_id</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">db</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">bookId</span><span style="color:#89DDFF;">=</span><span style="color:#82AAFF;">bookid</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">book</span><span style="color:#89DDFF;">=</span><span style="color:#82AAFF;">book</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 新增书籍</span></span>
<span class="line"><span style="color:#89DDFF;">@</span><span style="color:#82AAFF;">app</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">post</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">/books/</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">response_model</span><span style="color:#89DDFF;">=</span><span style="color:#82AAFF;">schemas</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">Books</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">create_book</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">book</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> schemas</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">BooksBase</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">db</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> Session </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Depends</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">get_db</span><span style="color:#89DDFF;">)):</span></span>
<span class="line"><span style="color:#A6ACCD;">    db_book </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> crud</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get_books_by_name</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">db</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">bookname</span><span style="color:#89DDFF;">=</span><span style="color:#82AAFF;">book</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">bookname</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> db_book</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">raise</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">HTTPException</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">status_code</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">400</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">detail</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">该书籍已经存在。</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> crud</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">create_book</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">db</span><span style="color:#89DDFF;">=</span><span style="color:#82AAFF;">db</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">book</span><span style="color:#89DDFF;">=</span><span style="color:#82AAFF;">book</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span></code></pre></div><p>至此，五个文件已经全部完成，接下来我们要测试一下这些功能。</p><div class="warning custom-block"><p class="custom-block-title">注意事项</p><p>在导入文件时，一定要注意： 上述文件中，我们是用<code>from . import XXX</code>的方式导入当前文件夹下的其它文件，在这种情况下，如果要成功运行，必须将目录切换至backend的上一级来运行才可以。如果省略.，直接用<code>import XXX</code>来导入当前文件夹下的其它文件，则必须在backend这个当前目录下运行服务器uvicorn的命令</p></div><p>我们采用在backend文件夹的上一级运行服务器的方式。</p><h2 id="五、测试增删改查功能" tabindex="-1">五、测试增删改查功能 <a class="header-anchor" href="#五、测试增删改查功能" aria-label="Permalink to &quot;五、测试增删改查功能&quot;">​</a></h2><p>将目录切换至backend的上一级，在命令窗口运行下列命令： <code>uvicorn backend.main:app --reload --port 8001</code> 然后你会发现在backend的上一级目录中生成了一个数据库文件sql_app.db，此时如果用DB Browser for SQLite这个软件来查看该数据库文件时，会发现我们定义的表已经在其中创建了。</p><p>在FastAPI中，有一个非常强大的文档功能，它可以让我们对刚才编写的程序进行测试。在浏览器地址栏输入<a href="http://127.0.0.1:8001/docs" target="_blank" rel="noreferrer">http://127.0.0.1:8001/docs</a>，进入swagger用户界面，用以管理接口数据。这里只用其来测试我们上述编写的代码是否能成功操作数据库。 <img src="`+o+'" alt="图 1"></p><ul><li>增加数据</li><li>查询</li><li>修改</li><li>删除</li></ul><h2 id="小结" tabindex="-1">小结 <a class="header-anchor" href="#小结" aria-label="Permalink to &quot;小结&quot;">​</a></h2><p>在本文中，我们用一个小例子来说明了如何利用FastAPI和SQLAlchemy来对数据库进行增删除改查操作，熟悉该过程，有助于我们加深对FastAPI操作数据库的理解。</p><h2 id="仓库代码" tabindex="-1">仓库代码 <a class="header-anchor" href="#仓库代码" aria-label="Permalink to &quot;仓库代码&quot;">​</a></h2><p><a href="https://gitee.com/windstarry/fastapi_vue_demo" target="_blank" rel="noreferrer">仓库代码展示</a></p><h2 id="相关文章" tabindex="-1">相关文章 <a class="header-anchor" href="#相关文章" aria-label="Permalink to &quot;相关文章&quot;">​</a></h2><ol><li><a href="./关于FastAPI与Vue3的通信.html">关于FastAPI与Vue3的通信</a></li><li><a href="./FastAPI对数据库的增删改查.html">FastAPI对数据库的增删改查</a></li><li><a href="./基于Vue3和FastAPI对数据库进行操作.html">基于Vue3和FastAPI对数据库进行操作</a></li></ol>',46),t=[e];function c(r,F,y,D,A,i){return a(),n("div",null,t)}const b=s(p,[["render",c]]);export{d as __pageData,b as default};
